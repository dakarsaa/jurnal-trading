<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dasbor Jurnal Trading Forex - Lengkap</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; padding: 2rem; }
        .container { background-color: #ffffff; padding: 1.5rem; border-radius: 0.75rem; box-shadow: 0 4px 6px rgba(0,0,0,0.1); max-width: 1200px; margin: auto; }
        .table-wrapper { max-height: 450px; overflow: auto; margin-bottom: 2rem; border: 1px solid #e5e7eb; border-radius: 0.5rem; }
        table { width: 100%; border-collapse: separate; border-spacing: 0; }
        th, td { padding: 0.75rem; text-align: left; border-bottom: 1px solid #e5e7eb; white-space: nowrap; }
        th { background-color: #f9fafb; font-weight: 600; color: #374151; position: sticky; top: 0; z-index: 10; }
        .profit { color: #10b981; font-weight: 600; }
        .loss { color: #ef4444; font-weight: 600; }
        .chart-container { width: 100%; height: 400px; margin-bottom: 2rem; }
        .stats-container { background-color: #ffffff; padding: 1.5rem; border-radius: 0.75rem; box-shadow: 0 4px 6px rgba(0,0,0,0.1); margin-top: 2rem; }
        .summary-item { display: flex; justify-content: space-between; padding: 0.5rem 0; border-bottom: 1px dashed #e5e7eb; }
        .summary-item:last-child { border-bottom: none; }
        .btn { padding: 0.75rem 1.5rem; border-radius: 0.5rem; font-weight: 600; cursor: pointer; transition: background-color 0.2s; }
        .btn-primary { background-color: #2563eb; color: white; }
        .btn-secondary { background-color: #6b7280; color: white; }
        .btn-edit, .btn-delete { padding: 0.25rem 0.5rem; border-radius: 0.375rem; font-size: 0.75rem; color: white; }
        .btn-edit { background-color: #f59e0b; }
        .btn-delete { background-color: #ef4444; }
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%; width: 40px; height: 40px; animation: spin 2s linear infinite; margin: 20px auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="text-3xl font-bold mb-6 text-gray-800 text-center">Dasbor Jurnal Trading Online</h1>
        
        <div id="loadingIndicator" class="text-center py-4"><div class="loader"></div><p>Memuat data...</p></div>

        <div id="dashboardContent" style="display: none;">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6 text-center">
                <div class="bg-gray-100 p-4 rounded-lg shadow-sm"><h3 class="text-sm font-medium text-gray-500 uppercase">Saldo Saat Ini</h3><p id="currentBalanceValue" class="text-2xl font-bold text-gray-800 mt-1">$0.00</p></div>
                <div class="bg-gray-100 p-4 rounded-lg shadow-sm"><h3 class="text-sm font-medium text-gray-500 uppercase">Total P/L</h3><p id="totalPlValue" class="text-2xl font-bold mt-1">$0.00</p></div>
                <div class="bg-gray-100 p-4 rounded-lg shadow-sm"><h3 class="text-sm font-medium text-gray-500 uppercase">P/L %</h3><p id="plPercentageValue" class="text-2xl font-bold mt-1">0.00%</p></div>
            </div>
            <div style="display: flex; justify-content: center; margin-bottom: 1.5rem;"><label for="initialBalance" class="font-bold mr-2 self-center">Saldo Awal (USD):</label><input type="number" id="initialBalance" value="1000" min="0" step="100" class="p-2 border rounded"></div>
            <h2 class="text-2xl font-bold mb-4 text-gray-800 text-center">Manajemen Trading</h2>
            <form id="tradeForm" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 bg-gray-50 p-4 rounded-lg shadow-sm mb-6">
                <div><label for="date">Tanggal & Waktu:</label><input type="datetime-local" id="date" class="w-full p-2 border rounded"></div>
                <div><label for="pair">Pair:</label><input type="text" id="pair" placeholder="EUR/USD" class="w-full p-2 border rounded"></div>
                <div><label for="lotSize">Lot:</label><input type="number" id="lotSize" step="0.01" min="0.01" class="w-full p-2 border rounded"></div>
                <div><label for="position">Posisi:</label><select id="position" class="w-full p-2 border rounded"><option value="Buy">Buy</option><option value="Sell">Sell</option></select></div>
                <div><label for="entryPrice">Harga Masuk:</label><input type="number" id="entryPrice" step="0.00001" class="w-full p-2 border rounded"></div>
                <div><label for="exitPrice">Harga Keluar:</label><input type="number" id="exitPrice" step="0.00001" class="w-full p-2 border rounded"></div>
                <div><label for="stopLoss">Stop Loss:</label><input type="number" id="stopLoss" step="0.00001" class="w-full p-2 border rounded"></div>
                <div><label for="takeProfit">Take Profit:</label><input type="number" id="takeProfit" step="0.00001" class="w-full p-2 border rounded"></div>
                <div><label for="timeframe">Timeframe:</label><select id="timeframe" class="w-full p-2 border rounded"><option>M15</option><option>M30</option><option>H1</option><option>H4</option><option>D1</option></select></div>
                <div><label for="reason">Strategi:</label><input type="text" id="reason" class="w-full p-2 border rounded"></div>
                <div><label for="emotion">Emosi:</label><select id="emotion" class="w-full p-2 border rounded"><option>Yakin</option><option>Cemas</option><option>Tenang</option><option>Optimis</option></select></div>
                <div><label for="lessons">Pelajaran:</label><input type="text" id="lessons" class="w-full p-2 border rounded"></div>
                <div class="col-span-full flex gap-4 mt-4">
                    <button type="submit" id="addOrUpdateTradeBtn" class="btn btn-primary">Tambah Trading</button>
                    <button type="button" id="cancelEditBtn" class="btn btn-secondary" style="display:none;">Batal</button>
                </div>
            </form>
            <h2 class="text-2xl font-bold my-6 text-gray-800 text-center">Data Histori Trading</h2>
            <div class="table-wrapper"><table id="tradingTable"><thead><tr><th>Aksi</th><th>Tanggal</th><th>Pair</th><th>Posisi</th><th>P/L (USD)</th><th>Pips</th><th>Lot</th><th>R:R</th><th>Strategi</th></tr></thead><tbody></tbody></table></div>
            <h2 class="text-2xl font-bold mb-4 text-gray-800 text-center">Grafik Equity (USD)</h2>
            <div class="chart-container"><svg id="equityChartUsd"></svg></div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-8">
                <div class="stats-container"><h2 class="text-2xl font-bold mb-4 text-center">Analisis Strategi</h2><div id="strategySummary"></div></div>
                <div class="stats-container"><h2 class="text-2xl font-bold mb-4 text-center">Analisis Timeframe</h2><div id="timeframeSummary"></div></div>
            </div>
            <div class="stats-container"><h2 class="text-2xl font-bold mb-4 text-center">Statistik Performa Trading</h2><table class="w-full"><tbody id="statisticsBody" class="divide-y"></tbody></table></div>
            <div class="stats-container">
                <h2 class="text-2xl font-bold mb-4 text-gray-800 text-center">Performa Periodik</h2>
                <h3 class="text-xl font-semibold mb-2 text-center">Mingguan</h3>
                <div class="table-wrapper" style="max-height: 200px; border: none;"><table id="weeklyPerformanceTable" class="w-full"><thead><tr><th>Minggu</th><th>Trades</th><th>Win Rate</th><th>Profit (USD)</th></tr></thead><tbody></tbody></table></div>
                <h3 class="text-xl font-semibold my-4 text-center">Bulanan</h3>
                <div class="table-wrapper" style="max-height: 200px; border: none;"><table id="monthlyPerformanceTable" class="w-full"><thead><tr><th>Bulan</th><th>Trades</th><th>Win Rate</th><th>Profit (USD)</th></tr></thead><tbody></tbody></table></div>
            </div>
        </div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', async function() {
        // ==================================================================
        // === KONFIGURASI WAJIB: GANTI DENGAN KUNCI RAHASIA ANDA ===
        // ==================================================================
        const AIRTABLE_API_KEY = "patgVfG7UrVD0cru3.f8411907bca108083167b58676e91078452dd530958923555bb0895e15d38457";
        const AIRTABLE_BASE_ID = "app0SlHtg1Nnb0H9B";
        const AIRTABLE_TABLE_NAME = "Trades";
        // ==================================================================

        const airtableUrl = `https://api.airtable.com/v0/${AIRTABLE_BASE_ID}/${AIRTABLE_TABLE_NAME}`;
        let tradingData = [];
        let recordBeingEditedId = null;

        const ui = {
            tradeForm: document.getElementById('tradeForm'),
            addOrUpdateTradeBtn: document.getElementById('addOrUpdateTradeBtn'),
            cancelEditBtn: document.getElementById('cancelEditBtn'),
            tableBody: document.querySelector('#tradingTable tbody'),
            initialBalanceInput: document.getElementById('initialBalance'),
            loadingIndicator: document.getElementById('loadingIndicator'),
            dashboardContent: document.getElementById('dashboardContent'),
        };

        const apiHeaders = { 'Authorization': `Bearer ${AIRTABLE_API_KEY}`, 'Content-Type': 'application/json' };

        async function apiCall(url, method = 'GET', body = null) {
            try {
                const options = { method, headers: apiHeaders };
                if (body) options.body = JSON.stringify(body);
                const response = await fetch(url, options);
                if (!response.ok) throw new Error(`API Error: ${response.statusText}`);
                return method === 'DELETE' ? response.ok : response.json();
            } catch (error) {
                console.error(`Error with ${method} request to ${url}:`, error);
                alert(`Terjadi kesalahan jaringan. Gagal ${method === 'GET' ? 'memuat' : 'menyimpan'} data.`);
                return null;
            }
        }

        async function fetchTrades() {
            ui.loadingIndicator.style.display = 'block';
            ui.dashboardContent.style.display = 'none';
            const data = await apiCall(airtableUrl);
            if (data && data.records) {
                tradingData = data.records.map(record => ({ id: record.id, ...record.fields }));
                fullUpdate();
            }
            ui.loadingIndicator.style.display = 'none';
            ui.dashboardContent.style.display = 'block';
        }

        function getInitialBalance() { return parseFloat(ui.initialBalanceInput.value) || 0; }
        function calculatePips(pair, position, entry, exit) {
            const multiplier = pair && pair.toUpperCase().includes('JPY') ? 100 : 10000;
            return parseFloat(((position === 'Buy' ? exit - entry : entry - exit) * multiplier).toFixed(1));
        }
        function calculateProfitInUsd(pair, pips, lotSize) {
            const pipValue = pair && pair.toUpperCase().includes('JPY') ? 7 : 10;
            return pips * (lotSize || 0) * pipValue;
        }
        function calculateRiskReward(position, entry, sl, tp) {
            if (!sl || !tp || !entry) return 'N/A';
            const profit = Math.abs(position === 'Buy' ? tp - entry : entry - tp);
            const loss = Math.abs(position === 'Buy' ? entry - sl : sl - entry);
            return loss > 0 ? `1:${(profit / loss).toFixed(2)}` : 'Inf';
        }

        function renderTable() {
            ui.tableBody.innerHTML = '';
            const sortedData = [...tradingData].sort((a, b) => new Date(b.date) - new Date(a.date));
            sortedData.forEach(trade => {
                const pips = calculatePips(trade.pair, trade.position, trade.entryPrice, trade.exitPrice);
                const profitUsd = calculateProfitInUsd(trade.pair, pips, trade.lotSize);
                const rr = calculateRiskReward(trade.position, trade.entryPrice, trade.stopLoss, trade.takeProfit);
                const profitClass = profitUsd >= 0 ? 'profit' : 'loss';
                const row = document.createElement('tr');
                row.dataset.id = trade.id;
                row.innerHTML = `
                    <td class="flex gap-2"><button class="btn-edit" data-id="${trade.id}">E</button><button class="btn-delete" data-id="${trade.id}">H</button></td>
                    <td>${new Date(trade.date).toLocaleDateString('id-ID')}</td>
                    <td>${trade.pair || ''}</td>
                    <td>${trade.position || ''}</td>
                    <td class="${profitClass}">$${profitUsd.toFixed(2)}</td>
                    <td class="${pips >= 0 ? 'profit' : 'loss'}">${pips}</td>
                    <td>${trade.lotSize || 0}</td>
                    <td>${rr}</td>
                    <td>${trade.reason || ''}</td>
                `;
                ui.tableBody.appendChild(row);
            });
        }
        
        function updateAllStats() {
            // Summary
            const initialBalance = getInitialBalance();
            const totalPl = tradingData.reduce((acc, trade) => acc + calculateProfitInUsd(trade.pair, calculatePips(trade.pair, trade.position, trade.entryPrice, trade.exitPrice), trade.lotSize), 0);
            document.getElementById('currentBalanceValue').textContent = `$${(initialBalance + totalPl).toFixed(2)}`;
            document.getElementById('totalPlValue').textContent = `$${totalPl.toFixed(2)}`;
            document.getElementById('plPercentageValue').textContent = `${initialBalance > 0 ? (totalPl / initialBalance * 100).toFixed(2) : 0}%`;

            // Detailed Stats
            const stats = tradingData.reduce((acc, trade) => {
                const profit = calculateProfitInUsd(trade.pair, calculatePips(trade.pair, trade.position, trade.entryPrice, trade.exitPrice), trade.lotSize);
                acc.total++;
                if (profit > 0) { acc.wins++; acc.grossProfit += profit; } else { acc.losses++; acc.grossLoss += profit; }
                return acc;
            }, { total: 0, wins: 0, losses: 0, grossProfit: 0, grossLoss: 0 });
            const winRate = stats.total > 0 ? (stats.wins / stats.total) * 100 : 0;
            const avgWin = stats.wins > 0 ? stats.grossProfit / stats.wins : 0;
            const avgLoss = stats.losses > 0 ? stats.grossLoss / stats.losses : 0;
            const profitFactor = stats.grossLoss !== 0 ? Math.abs(stats.grossProfit / stats.grossLoss) : Infinity;
            document.getElementById('statisticsBody').innerHTML = `
                <tr><td class="py-2">Total Trades</td><td class="text-right">${stats.total}</td></tr>
                <tr><td class="py-2">Winning Trades</td><td class="text-right">${stats.wins} (${winRate.toFixed(2)}%)</td></tr>
                <tr><td class="py-2">Losing Trades</td><td class="text-right">${stats.losses}</td></tr>
                <tr><td class="py-2">Profit Factor</td><td class="text-right">${profitFactor === Infinity ? 'Inf' : profitFactor.toFixed(2)}</td></tr>
                <tr><td class="py-2">Rata-rata Keuntungan</td><td class="text-right profit">$${avgWin.toFixed(2)}</td></tr>
                <tr><td class="py-2">Rata-rata Kerugian</td><td class="text-right loss">$${avgLoss.toFixed(2)}</td></tr>
            `;

            // Strategy & Timeframe Summaries
            const renderSummary = (containerId, key) => {
                const summary = tradingData.reduce((acc, trade) => {
                    const k = trade[key] || 'N/A';
                    if (!acc[k]) acc[k] = { total: 0, wins: 0 };
                    acc[k].total++;
                    if (calculatePips(trade.pair, trade.position, trade.entryPrice, trade.exitPrice) > 0) acc[k].wins++;
                    return acc;
                }, {});
                document.getElementById(containerId).innerHTML = Object.entries(summary).sort().map(([k, v]) => `
                    <div class="summary-item"><span>${k}</span><span class="percentage">${((v.wins / v.total) * 100).toFixed(1)}%</span></div>
                `).join('');
            };
            renderSummary('strategySummary', 'reason');
            renderSummary('timeframeSummary', 'timeframe');

            // Periodic Performance
            const getWeekKey = d => { const date = new Date(d); date.setDate(date.getDate() - date.getDay() + 1); return date.toISOString().split('T')[0]; };
            const getMonthKey = d => new Date(d).toISOString().slice(0, 7);
            const renderPeriodicPerf = (tableId, grouper) => {
                const perf = tradingData.reduce((acc, trade) => {
                    const key = grouper(trade.date);
                    if (!acc[key]) acc[key] = { trades: 0, wins: 0, profit: 0 };
                    const profit = calculateProfitInUsd(trade.pair, calculatePips(trade.pair, trade.position, trade.entryPrice, trade.exitPrice), trade.lotSize);
                    acc[key].trades++;
                    acc[key].profit += profit;
                    if (profit > 0) acc[key].wins++;
                    return acc;
                }, {});
                document.querySelector(`#${tableId} tbody`).innerHTML = Object.entries(perf).sort().reverse().map(([period, stats]) => `
                    <tr><td>${period}</td><td>${stats.trades}</td><td>${((stats.wins / stats.trades) * 100).toFixed(1)}%</td><td class="${stats.profit >= 0 ? 'profit' : 'loss'}">$${stats.profit.toFixed(2)}</td></tr>
                `).join('');
            };
            renderPeriodicPerf('weeklyPerformanceTable', getWeekKey);
            renderPeriodicPerf('monthlyPerformanceTable', getMonthKey);
        }

        function drawEquityChart() {
            const svg = d3.select("#equityChartUsd");
            svg.selectAll("*").remove(); // Membersihkan grafik sebelumnya

            const margin = { top: 20, right: 30, bottom: 40, left: 60 }; // Beri ruang lebih untuk label Y
            // Memastikan ada lebar minimum untuk mencegah error
            const parentWidth = svg.node().parentNode.clientWidth;
            if (parentWidth <= margin.left + margin.right) return; // Keluar jika container terlalu kecil
            
            const width = parentWidth - margin.left - margin.right;
            const height = 400 - margin.top - margin.bottom;

            const g = svg.append("g").attr("transform", `translate(${margin.left},${margin.top})`);
            
            const initialBalance = getInitialBalance();
            let cumulativeEquity = initialBalance;

            // Membuat data point untuk grafik
            const chartData = [{ index: 0, equityUsd: initialBalance }];
            [...tradingData]
                .sort((a, b) => new Date(a.date) - new Date(b.date)) // Urutkan trading dari yang terlama
                .forEach((trade, i) => {
                    const pips = calculatePips(trade.pair, trade.position, trade.entryPrice, trade.exitPrice);
                    const profit = calculateProfitInUsd(trade.pair, pips, trade.lotSize);
                    cumulativeEquity += profit;
                    chartData.push({ index: i + 1, equityUsd: cumulativeEquity });
                });

            // Jangan gambar jika tidak ada data trading
            if (chartData.length <= 1) return;

            // Pengaturan Sumbu X (berdasarkan jumlah trading)
            const x = d3.scaleLinear()
                .domain([0, chartData.length - 1])
                .range([0, width]);

            // Pengaturan Sumbu Y (berdasarkan nilai equity)
            const y = d3.scaleLinear()
                .domain(d3.extent(chartData, d => d.equityUsd)).nice()
                .range([height, 0]);

            // Menggambar area di bawah garis
            g.append("path")
                .datum(chartData)
                .attr("fill", "#dcfce7")
                .attr("d", d3.area()
                    .x(d => x(d.index))
                    .y0(y(initialBalance))
                    .y1(d => y(d.equityUsd))
                );

            // Menggambar garis equity
            g.append("path")
                .datum(chartData)
                .attr("fill", "none")
                .attr("stroke", "#22c55e")
                .attr("stroke-width", 2)
                .attr("d", d3.line()
                    .x(d => x(d.index))
                    .y(d => y(d.equityUsd))
                );

            // Menambahkan Sumbu X ke grafik
            g.append("g")
                .attr("transform", `translate(0,${height})`)
                .call(d3.axisBottom(x).ticks(Math.min(10, chartData.length - 1)).tickFormat(d3.format("d")));

            // Menambahkan Sumbu Y ke grafik
            g.append("g")
                .call(d3.axisLeft(y).tickFormat(d3.format("$,.0f")));
        }

        function resetForm() {
            ui.tradeForm.reset();
            recordBeingEditedId = null;
            ui.addOrUpdateTradeBtn.textContent = 'Tambah Trading';
            ui.cancelEditBtn.style.display = 'none';
            document.getElementById('date').value = new Date().toISOString().slice(0, 16);
        }

        ui.tradeForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const fields = Array.from(ui.tradeForm.elements).reduce((acc, el) => {
                if (el.id && el.value) {
                    acc[el.id] = el.type === 'number' ? parseFloat(el.value) : el.value;
                }
                return acc;
            }, {});
            
            ui.addOrUpdateTradeBtn.disabled = true;
            ui.addOrUpdateTradeBtn.textContent = 'Menyimpan...';

            if (recordBeingEditedId) {
                await apiCall(`${airtableUrl}/${recordBeingEditedId}`, 'PATCH', { fields });
            } else {
                await apiCall(airtableUrl, 'POST', { fields });
            }
            
            await fetchTrades();
            ui.addOrUpdateTradeBtn.disabled = false;
            resetForm();
        });

        ui.tableBody.addEventListener('click', (e) => {
            const { id } = e.target.dataset;
            if (e.target.classList.contains('btn-delete')) {
                if (confirm('Anda yakin ingin menghapus data ini secara permanen?')) {
                    deleteTrade(id);
                }
            } else if (e.target.classList.contains('btn-edit')) {
                const trade = tradingData.find(t => t.id === id);
                recordBeingEditedId = id;
                Object.keys(trade).forEach(key => {
                    const el = document.getElementById(key);
                    if (el) el.value = trade[key];
                });
                ui.addOrUpdateTradeBtn.textContent = 'Update Trading';
                ui.cancelEditBtn.style.display = 'inline-block';
                ui.tradeForm.scrollIntoView({ behavior: 'smooth' });
            }
        });

        ui.cancelEditBtn.addEventListener('click', resetForm);
        ui.initialBalanceInput.addEventListener('change', fullUpdate);
        window.addEventListener('resize', drawEquityChart);

        function fullUpdate() {
            renderTable();
            updateAllStats();
            drawEquityChart();
        }

        resetForm();
        fetchTrades();
    });
    </script>
</body>
</html>

