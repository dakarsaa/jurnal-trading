<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dasbor Jurnal Trading Forex - Final</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; padding: 2rem; }
        .container { background-color: #ffffff; padding: 1.5rem; border-radius: 0.75rem; box-shadow: 0 4px 6px rgba(0,0,0,0.1); max-width: 1200px; margin: auto; }
        .table-wrapper { max-height: 450px; overflow: auto; margin-bottom: 2rem; border: 1px solid #e5e7eb; border-radius: 0.5rem; }
        table { width: 100%; border-collapse: separate; border-spacing: 0; }
        th, td { padding: 0.75rem; text-align: left; border-bottom: 1px solid #e5e7eb; white-space: nowrap; }
        th { background-color: #f9fafb; font-weight: 600; color: #374151; position: sticky; top: 0; z-index: 10; }
        .profit { color: #10b981; font-weight: 600; }
        .loss { color: #ef4444; font-weight: 600; }
        .chart-container { width: 100%; height: 400px; margin-bottom: 2rem; }
        .stats-container { background-color: #ffffff; padding: 1.5rem; border-radius: 0.75rem; box-shadow: 0 4px 6px rgba(0,0,0,0.1); margin-top: 2rem; }
        .btn { padding: 0.75rem 1.5rem; border-radius: 0.5rem; font-weight: 600; cursor: pointer; transition: background-color 0.2s; }
        .btn-primary { background-color: #2563eb; color: white; }
        .btn-secondary { background-color: #6b7280; color: white; }
        .btn-edit, .btn-delete { padding: 0.25rem 0.5rem; border-radius: 0.375rem; font-size: 0.75rem; color: white; }
        .btn-edit { background-color: #f59e0b; }
        .btn-delete { background-color: #ef4444; }
        #syncStatus { font-size: 0.8rem; color: #6b7280; text-align: center; margin-top: -1rem; margin-bottom: 1rem; }
        .summary-item { display: flex; justify-content: space-between; padding: 0.5rem 0; border-bottom: 1px dashed #e5e7eb; }
        .summary-item:last-child { border-bottom: none; }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="text-3xl font-bold mb-6 text-gray-800 text-center">Dakarsa Trading Journal</h1>
        <div id="syncStatus">Loading data...</div>
        
        <div id="dashboardContent">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6 text-center">
                <div class="bg-gray-100 p-4 rounded-lg shadow-sm"><h3 class="text-sm font-medium text-gray-500 uppercase">Current Balance</h3><p id="currentBalanceValue" class="text-2xl font-bold text-gray-800 mt-1">$0.00</p></div>
                <div class="bg-gray-100 p-4 rounded-lg shadow-sm"><h3 class="text-sm font-medium text-gray-500 uppercase">Total P/L</h3><p id="totalPlValue" class="text-2xl font-bold mt-1">$0.00</p></div>
                <div class="bg-gray-100 p-4 rounded-lg shadow-sm"><h3 class="text-sm font-medium text-gray-500 uppercase">P/L %</h3><p id="plPercentageValue" class="text-2xl font-bold mt-1">0.00%</p></div>
            </div>
            <div style="display: flex; justify-content: center; margin-bottom: 1.5rem;">
    <label for="initialBalance" class="font-bold mr-2 self-center">Initial Balance (USD):</label>
    <input type="number" id="initialBalance" value="1000" min="0" step="100" class="p-2 border rounded">
    <label class="ml-4 self-center">
        <input type="checkbox" id="toggleInitialBalance" class="mr-1">
        Hide
    </label>
    </div>
            <h2 class="text-2xl font-bold mb-4 text-gray-800 text-center">Trading Management</h2>
            <form id="tradeForm" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 bg-gray-50 p-4 rounded-lg shadow-sm mb-6">
                <div><label for="date">Date & Time:</label><input type="datetime-local" id="date" class="w-full p-2 border rounded"></div>
                <div><label for="pair">Pair:</label><input type="text" id="pair" placeholder="EUR/USD" class="w-full p-2 border rounded"></div>
                <div><label for="lotSize">Lot:</label><input type="number" id="lotSize" step="0.01" min="0.01" class="w-full p-2 border rounded"></div>
                <div><label for="position">Position:</label><select id="position" class="w-full p-2 border rounded"><option value="Buy">Buy</option><option value="Sell">Sell</option></select></div>
                <div><label for="entryPrice">Entry Price:</label><input type="number" id="entryPrice" step="0.00001" class="w-full p-2 border rounded"></div>
                <div><label for="exitPrice">Exit Price:</label><input type="number" id="exitPrice" step="0.00001" class="w-full p-2 border rounded"></div>
                <div><label for="stopLoss">Stop Loss:</label><input type="number" id="stopLoss" step="0.00001" class="w-full p-2 border rounded"></div>
                <div><label for="takeProfit">Take Profit:</label><input type="number" id="takeProfit" step="0.00001" class="w-full p-2 border rounded"></div>
                <div><label for="timeframe">Timeframe:</label><select id="timeframe" class="w-full p-2 border rounded"><option>M15</option><option>M30</option><option>H1</option><option>H4</option><option>D1</option></select></div>
                <div><label for="reason">Strategy:</label><input type="text" id="reason" class="w-full p-2 border rounded"></div>
                <div><label for="emotion">Emotion:</label><select id="emotion" class="w-full p-2 border rounded"><option>Yakin</option><option>Cemas</option><option>Tenang</option><option>Optimis</option></select></div>
                <div><label for="lessons">Remarks:</label><input type="text" id="lessons" class="w-full p-2 border rounded"></div>
                <div class="col-span-full flex gap-4 mt-4">
                    <button type="submit" id="addOrUpdateTradeBtn" class="btn btn-primary">Add Trading</button>
                    <button type="button" id="cancelEditBtn" class="btn btn-secondary" style="display:none;">Cancel</button>
                </div>
            </form>
            <h2 class="text-2xl font-bold my-6 text-gray-800 text-center">Trading History</h2>
            <div class="table-wrapper"><table id="tradingTable"><thead><tr><th>Action</th><th>Date</th><th>Pair</th><th>Position</th><th>P/L (USD)</th><th>Pips</th><th>Lot</th><th>R:R</th><th>Strategy</th></tr></thead><tbody></tbody></table></div>
            <h2 class="text-2xl font-bold mb-4 text-gray-800 text-center">Balance (USD)</h2>
            <div class="chart-container"><svg id="equityChartUsd"></svg></div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-8">
                <div class="stats-container"><h2 class="text-2xl font-bold mb-4 text-center">Strategy Analysis</h2><div id="strategySummary"></div></div>
                <div class="stats-container"><h2 class="text-2xl font-bold mb-4 text-center">Timeframe Analysis</h2><div id="timeframeSummary"></div></div>
            </div>
            <div class="stats-container"><h2 class="text-2xl font-bold mb-4 text-center">Trading Performance</h2><table class="w-full"><tbody id="statisticsBody" class="divide-y"></tbody></table></div>
            <div class="stats-container">
                <h2 class="text-2xl font-bold mb-4 text-gray-800 text-center">Periodical Performance</h2>
                <h3 class="text-xl font-semibold mb-2 text-center">Weekly</h3>
                <div class="table-wrapper" style="max-height: 200px; border: none;"><table id="weeklyPerformanceTable" class="w-full"><thead><tr><th>Week</th><th>Trades</th><th>Win Rate</th><th>Profit (USD)</th></tr></thead><tbody></tbody></table></div>
                <h3 class="text-xl font-semibold my-4 text-center">Monthly</h3>
                <div class="table-wrapper" style="max-height: 200px; border: none;"><table id="monthlyPerformanceTable" class="w-full"><thead><tr><th>Month</th><th>Trades</th><th>Win Rate</th><th>Profit (USD)</th></tr></thead><tbody></tbody></table></div>
            </div>
        </div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', function() {
        document.getElementById('toggleInitialBalance').addEventListener('change', function() {
    const input = document.getElementById('initialBalance');
    input.style.display = this.checked ? 'none' : 'inline-block';
    });
        // ==================================================================
        // === KONFIGURASI WAJIB: GANTI DENGAN KUNCI RAHASIA ANDA ===
        // ==================================================================
        const AIRTABLE_API_KEY = "patgVfG7UrVD0cru3.f8411907bca108083167b58676e91078452dd530958923555bb0895e15d38457";
        const AIRTABLE_BASE_ID = "app0SlHtg1Nnb0H9B";
        const AIRTABLE_TABLE_NAME = "Trades";
        // ==================================================================

        const airtableUrl = `https://api.airtable.com/v0/${AIRTABLE_BASE_ID}/${encodeURIComponent(AIRTABLE_TABLE_NAME)}`;
        let tradingData = [];
        let recordBeingEditedId = null;

        const ui = {
            tradeForm: document.getElementById('tradeForm'),
            addOrUpdateTradeBtn: document.getElementById('addOrUpdateTradeBtn'),
            cancelEditBtn: document.getElementById('cancelEditBtn'),
            tableBody: document.querySelector('#tradingTable tbody'),
            initialBalanceInput: document.getElementById('initialBalance'),
            syncStatus: document.getElementById('syncStatus')
        };

        const apiHeaders = { 'Authorization': `Bearer ${AIRTABLE_API_KEY}`, 'Content-Type': 'application/json' };

        // --- CACHING LOGIC ---
        function saveToCache(data) { localStorage.setItem('tradingDataCache', JSON.stringify(data)); }
        function loadFromCache() {
            const cachedData = localStorage.getItem('tradingDataCache');
            return cachedData ? JSON.parse(cachedData) : [];
        }

        async function syncWithAirtable() {
            ui.syncStatus.textContent = 'Menyinkronkan dengan server...';
            try {
                const response = await fetch(airtableUrl, { headers: apiHeaders });
                if (!response.ok) throw new Error('Gagal mengambil data dari server');
                const data = await response.json();
                const freshData = data.records.map(record => ({ id: record.id, ...record.fields }));
                
                tradingData = freshData;
                saveToCache(freshData);
                fullUpdate();
                ui.syncStatus.textContent = `Data disinkronkan pada ${new Date().toLocaleTimeString()}`;
            } catch (error) {
                console.error("Sinkronisasi gagal:", error);
                ui.syncStatus.textContent = 'Gagal sinkronisasi, menampilkan data offline.';
            }
        }

        // --- CORE FUNCTIONS ---
        function getInitialBalance() { return parseFloat(ui.initialBalanceInput.value) || 0; }
        function calculatePips(pair, position, entry, exit) {
            if (!pair || !position || typeof entry !== 'number' || typeof exit !== 'number') return 0;
            const multiplier = pair.toUpperCase().includes('JPY') ? 100 : 10000;
            return parseFloat(((position === 'Buy' ? exit - entry : entry - exit) * multiplier).toFixed(1));
        }
        function calculateProfitInUsd(pair, pips, lotSize) {
            if (!pair) return 0;
            const pipValue = pair.toUpperCase().includes('JPY') ? 7 : 10;
            return pips * (lotSize || 0) * pipValue;
        }
        function calculateRiskReward(position, entry, sl, tp) {
            if (!sl || !tp || !entry) return 'N/A';
            const profit = Math.abs(position === 'Buy' ? tp - entry : entry - tp);
            const loss = Math.abs(position === 'Buy' ? entry - sl : sl - entry);
            return loss > 0 ? `1:${(profit / loss).toFixed(2)}` : 'Inf';
        }

        function renderTable() {
            ui.tableBody.innerHTML = '';
            const sortedData = [...tradingData].sort((a, b) => new Date(b.date) - new Date(a.date));
            sortedData.forEach(trade => {
                const pips = calculatePips(trade.pair, trade.position, trade.entryPrice, trade.exitPrice);
                const profitUsd = calculateProfitInUsd(trade.pair, pips, trade.lotSize);
                const rr = calculateRiskReward(trade.position, trade.entryPrice, trade.stopLoss, trade.takeProfit);
                const profitClass = profitUsd >= 0 ? 'profit' : 'loss';
                const row = document.createElement('tr');
                row.dataset.id = trade.id;
                row.innerHTML = `
                    <td class="flex gap-2"><button class="btn-edit" data-id="${trade.id}">E</button><button class="btn-delete" data-id="${trade.id}">H</button></td>
                    <td>${new Date(trade.date).toLocaleDateString('id-ID')}</td>
                    <td>${trade.pair || ''}</td>
                    <td>${trade.position || ''}</td>
                    <td class="${profitClass}">$${profitUsd.toFixed(2)}</td>
                    <td class="${pips >= 0 ? 'profit' : 'loss'}">${pips}</td>
                    <td>${trade.lotSize || 0}</td>
                    <td>${rr}</td>
                    <td>${trade.reason || ''}</td>
                `;
                ui.tableBody.appendChild(row);
            });
        }
        
        function updateAllStats() {
            const initialBalance = getInitialBalance();
            const totalPl = tradingData.reduce((acc, trade) => acc + calculateProfitInUsd(trade.pair, calculatePips(trade.pair, trade.position, trade.entryPrice, trade.exitPrice), trade.lotSize), 0);
            document.getElementById('currentBalanceValue').textContent = `$${(initialBalance + totalPl).toFixed(2)}`;
            document.getElementById('totalPlValue').textContent = `$${totalPl.toFixed(2)}`;
            document.getElementById('plPercentageValue').textContent = `${initialBalance > 0 ? (totalPl / initialBalance * 100).toFixed(2) : 0}%`;

            const stats = tradingData.reduce((acc, trade) => {
                const profit = calculateProfitInUsd(trade.pair, calculatePips(trade.pair, trade.position, trade.entryPrice, trade.exitPrice), trade.lotSize);
                acc.total++;
                if (profit > 0) { acc.wins++; acc.grossProfit += profit; } else { acc.losses++; acc.grossLoss += profit; }
                return acc;
            }, { total: 0, wins: 0, losses: 0, grossProfit: 0, grossLoss: 0 });
            const winRate = stats.total > 0 ? (stats.wins / stats.total) * 100 : 0;
            const avgWin = stats.wins > 0 ? stats.grossProfit / stats.wins : 0;
            const avgLoss = stats.losses > 0 ? stats.grossLoss / stats.losses : 0;
            const profitFactor = stats.grossLoss !== 0 ? Math.abs(stats.grossProfit / stats.grossLoss) : Infinity;
            document.getElementById('statisticsBody').innerHTML = `
                <tr><td class="py-2">Total Trades</td><td class="text-right">${stats.total}</td></tr>
                <tr><td class="py-2">Winning Trades</td><td class="text-right">${stats.wins} (${winRate.toFixed(2)}%)</td></tr>
                <tr><td class="py-2">Losing Trades</td><td class="text-right">${stats.losses}</td></tr>
                <tr><td class="py-2">Profit Factor</td><td class="text-right">${profitFactor === Infinity ? 'Inf' : profitFactor.toFixed(2)}</td></tr>
                <tr><td class="py-2">Average Profit</td><td class="text-right profit">$${avgWin.toFixed(2)}</td></tr>
                <tr><td class="py-2">Average Loss</td><td class="text-right loss">$${avgLoss.toFixed(2)}</td></tr>
            `;

            const renderSummary = (containerId, key) => {
                const summary = tradingData.reduce((acc, trade) => {
                    const k = trade[key] || 'N/A';
                    if (!acc[k]) acc[k] = { total: 0, wins: 0 };
                    acc[k].total++;
                    if (calculatePips(trade.pair, trade.position, trade.entryPrice, trade.exitPrice) > 0) acc[k].wins++;
                    return acc;
                }, {});
                document.getElementById(containerId).innerHTML = Object.entries(summary).sort().map(([k, v]) => `
                    <div class="summary-item"><span>${k}</span><span class="percentage">${((v.wins / v.total) * 100).toFixed(1)}%</span></div>
                `).join('');
            };
            renderSummary('strategySummary', 'reason');
            renderSummary('timeframeSummary', 'timeframe');

            const getWeekKey = d => { const date = new Date(d); date.setDate(date.getDate() - (date.getDay() + 6) % 7); return date.toISOString().split('T')[0]; };
            const getMonthKey = d => new Date(d).toISOString().slice(0, 7);
            const renderPeriodicPerf = (tableId, grouper) => {
                const perf = tradingData.reduce((acc, trade) => {
                    const key = grouper(trade.date);
                    if (!acc[key]) acc[key] = { trades: 0, wins: 0, profit: 0 };
                    const profit = calculateProfitInUsd(trade.pair, calculatePips(trade.pair, trade.position, trade.entryPrice, trade.exitPrice), trade.lotSize);
                    acc[key].trades++;
                    acc[key].profit += profit;
                    if (profit > 0) acc[key].wins++;
                    return acc;
                }, {});
                document.querySelector(`#${tableId} tbody`).innerHTML = Object.entries(perf).sort((a,b) => b[0].localeCompare(a[0])).map(([period, stats]) => `
                    <tr><td>${period}</td><td>${stats.trades}</td><td>${((stats.wins / stats.trades) * 100).toFixed(1)}%</td><td class="${stats.profit >= 0 ? 'profit' : 'loss'}">$${stats.profit.toFixed(2)}</td></tr>
                `).join('');
            };
            renderPeriodicPerf('weeklyPerformanceTable', getWeekKey);
            renderPeriodicPerf('monthlyPerformanceTable', getMonthKey);
        }

        function drawEquityChart() {
    const svg = d3.select("#equityChartUsd");
    svg.selectAll("*").remove();
    
    const container = document.querySelector('.chart-container');
    if (!container) {
        console.error("Chart container not found");
        return;
    }
    
    // Set SVG dimensions
    const containerWidth = container.clientWidth;
    const containerHeight = 400;
    
    if (containerWidth === 0) {
        console.warn("Container width is 0, retrying in 100ms");
        setTimeout(drawEquityChart, 100);
        return;
    }
    
    svg.attr("width", containerWidth).attr("height", containerHeight);
    
    const margin = { top: 20, right: 30, bottom: 40, left: 80 };
    const width = containerWidth - margin.left - margin.right;
    const height = containerHeight - margin.top - margin.bottom;

    const g = svg.append("g").attr("transform", `translate(${margin.left},${margin.top})`);
    
    // Prepare data
    const initialBalance = getInitialBalance();
    let cumulativeEquity = initialBalance;
    const chartData = [{ index: 0, equityUsd: initialBalance, date: "Start" }];
    
    // Sort trades by date
    const sortedTrades = [...tradingData].sort((a, b) => new Date(a.date) - new Date(b.date));
    
    sortedTrades.forEach((trade, i) => {
        const pips = calculatePips(trade.pair, trade.position, trade.entryPrice, trade.exitPrice);
        const profitUsd = calculateProfitInUsd(trade.pair, pips, trade.lotSize);
        cumulativeEquity += profitUsd;
        chartData.push({ 
            index: i + 1, 
            equityUsd: cumulativeEquity, 
            date: new Date(trade.date).toLocaleDateString('id-ID'),
            profit: profitUsd
        });
    });

    // If no data, show initial balance line only
    if (chartData.length <= 1) {
        const y = d3.scaleLinear()
            .domain([initialBalance * 0.9, initialBalance * 1.1])
            .range([height, 0]);
            
        // Draw initial balance line
        g.append("line")
            .attr("x1", 0)
            .attr("x2", width)
            .attr("y1", y(initialBalance))
            .attr("y2", y(initialBalance))
            .attr("stroke", "#22c55e")
            .attr("stroke-width", 2)
            .attr("stroke-dasharray", "5,5");
            
        // Add axes
        g.append("g")
            .attr("transform", `translate(0,${height})`)
            .call(d3.axisBottom(d3.scaleLinear().domain([0, 10]).range([0, width])));
            
        g.append("g")
            .call(d3.axisLeft(y).tickFormat(d3.format("$,.0f")));
            
        // Add label
        g.append("text")
            .attr("x", width / 2)
            .attr("y", height / 2)
            .attr("text-anchor", "middle")
            .attr("fill", "#6b7280")
            .text("Belum ada data trading");
            
        return;
    }

    // Create scales
    const x = d3.scaleLinear()
        .domain([0, chartData.length - 1])
        .range([0, width]);

    const yExtent = d3.extent(chartData, d => d.equityUsd);
    const yPadding = (yExtent[1] - yExtent[0]) * 0.1 || initialBalance * 0.1;
    const y = d3.scaleLinear()
        .domain([yExtent[0] - yPadding, yExtent[1] + yPadding])
        .nice()
        .range([height, 0]);

    // Create line generator
    const line = d3.line()
        .x(d => x(d.index))
        .y(d => y(d.equityUsd))
        .curve(d3.curveMonotoneX);

    // Create area generator
    const area = d3.area()
        .x(d => x(d.index))
        .y0(y(initialBalance))
        .y1(d => y(d.equityUsd))
        .curve(d3.curveMonotoneX);

    // Add gradient definition
    const defs = svg.append("defs");
    const gradient = defs.append("linearGradient")
        .attr("id", "equityGradient")
        .attr("gradientUnits", "userSpaceOnUse")
        .attr("x1", 0).attr("y1", y(Math.max(...chartData.map(d => d.equityUsd))))
        .attr("x2", 0).attr("y2", y(Math.min(...chartData.map(d => d.equityUsd))));

    gradient.append("stop")
        .attr("offset", "0%")
        .attr("stop-color", "#22c55e")
        .attr("stop-opacity", 0.3);

    gradient.append("stop")
        .attr("offset", "100%")
        .attr("stop-color", "#22c55e")
        .attr("stop-opacity", 0.1);

    // Draw area
    g.append("path")
        .datum(chartData)
        .attr("fill", "url(#equityGradient)")
        .attr("d", area);

    // Draw line
    g.append("path")
        .datum(chartData)
        .attr("fill", "none")
        .attr("stroke", "#22c55e")
        .attr("stroke-width", 2)
        .attr("d", line);

    // Add initial balance reference line
    g.append("line")
        .attr("x1", 0)
        .attr("x2", width)
        .attr("y1", y(initialBalance))
        .attr("y2", y(initialBalance))
        .attr("stroke", "#6b7280")
        .attr("stroke-width", 1)
        .attr("stroke-dasharray", "3,3")
        .attr("opacity", 0.5);

    // Add dots for data points
    g.selectAll(".dot")
        .data(chartData.slice(1)) // Skip initial point
        .enter().append("circle")
        .attr("class", "dot")
        .attr("cx", d => x(d.index))
        .attr("cy", d => y(d.equityUsd))
        .attr("r", 3)
        .attr("fill", d => d.profit >= 0 ? "#22c55e" : "#ef4444")
        .attr("stroke", "white")
        .attr("stroke-width", 1);

    // Add X axis
    const xAxis = g.append("g")
        .attr("transform", `translate(0,${height})`)
        .call(d3.axisBottom(x)
            .ticks(Math.min(10, chartData.length - 1))
            .tickFormat(d3.format("d")));

    // Add Y axis
    g.append("g")
        .call(d3.axisLeft(y).tickFormat(d3.format("$,.0f")));

    // Add axis labels
    g.append("text")
        .attr("transform", "rotate(-90)")
        .attr("y", 0 - margin.left)
        .attr("x", 0 - (height / 2))
        .attr("dy", "1em")
        .style("text-anchor", "middle")
        .style("font-size", "12px")
        .style("fill", "#6b7280")
        .text("Equity (USD)");

    g.append("text")
        .attr("transform", `translate(${width / 2}, ${height + margin.bottom - 5})`)
        .style("text-anchor", "middle")
        .style("font-size", "12px")
        .style("fill", "#6b7280")
        .text("Trade Sequence");

    // Add tooltip
    const tooltip = d3.select("body").append("div")
        .attr("class", "tooltip")
        .style("position", "absolute")
        .style("background", "rgba(0, 0, 0, 0.8)")
        .style("color", "white")
        .style("padding", "8px")
        .style("border-radius", "4px")
        .style("font-size", "12px")
        .style("pointer-events", "none")
        .style("opacity", 0)
        .style("z-index", 1000);

    // Add invisible overlay for mouse events
    const overlay = g.append("rect")
        .attr("width", width)
        .attr("height", height)
        .style("fill", "none")
        .style("pointer-events", "all");

    overlay.on("mousemove", function(event) {
        const mouseX = d3.pointer(event, this)[0];
        const index = Math.round(x.invert(mouseX));
        
        if (index >= 0 && index < chartData.length) {
            const data = chartData[index];
            tooltip.transition().duration(200).style("opacity", 0.9);
            tooltip.html(`
                <div><strong>Trade #${index}</strong></div>
                <div>Equity: $${data.equityUsd.toFixed(2)}</div>
                ${data.profit !== undefined ? `<div>P/L: $${data.profit.toFixed(2)}</div>` : ''}
                ${data.date !== "Start" ? `<div>Date: ${data.date}</div>` : ''}
            `)
            .style("left", (event.pageX + 10) + "px")
            .style("top", (event.pageY - 10) + "px");
        }
    })
    .on("mouseout", function() {
        tooltip.transition().duration(500).style("opacity", 0);
    });

    // Remove tooltip when component is destroyed
    setTimeout(() => {
        const existingTooltip = d3.select(".tooltip");
        if (!existingTooltip.empty()) {
            existingTooltip.remove();
        }
    }, 100);
}
        function resetForm() {
            ui.tradeForm.reset();
            recordBeingEditedId = null;
            ui.addOrUpdateTradeBtn.textContent = 'Tambah Trading';
            ui.addOrUpdateTradeBtn.disabled = false;
            ui.cancelEditBtn.style.display = 'none';
            document.getElementById('date').value = new Date().toISOString().slice(0, 16);
        }
        
        async function handleFormSubmit(e) {
            e.preventDefault();
            const fields = Array.from(ui.tradeForm.elements).reduce((acc, el) => {
                if (el.id && el.value) { acc[el.id] = el.type === 'number' ? parseFloat(el.value) : el.value; }
                return acc;
            }, {});
            ui.addOrUpdateTradeBtn.disabled = true;
            ui.addOrUpdateTradeBtn.textContent = 'Menyimpan...';

            let response;
            if (recordBeingEditedId) {
                response = await fetch(`${airtableUrl}/${recordBeingEditedId}`, { method: 'PATCH', headers: apiHeaders, body: JSON.stringify({ fields }) });
            } else {
                response = await fetch(airtableUrl, { method: 'POST', headers: apiHeaders, body: JSON.stringify({ fields }) });
            }
            
            if (response.ok) {
                await syncWithAirtable();
            } else {
                alert("Gagal menyimpan data ke server.");
            }
            resetForm();
        }

        async function handleDelete(id) {
            if (confirm('Anda yakin ingin menghapus data ini secara permanen?')) {
                const response = await fetch(`${airtableUrl}/${id}`, { method: 'DELETE', headers: apiHeaders });
                if (response.ok) {
                    await syncWithAirtable();
                } else {
                    alert("Gagal menghapus data dari server.");
                }
            }
        }

        ui.tradeForm.addEventListener('submit', handleFormSubmit);

        ui.tableBody.addEventListener('click', (e) => {
            const button = e.target.closest('button');
            if (!button) return;
            const id = button.dataset.id;
            
            if (button.classList.contains('btn-delete')) {
                handleDelete(id);
            } else if (button.classList.contains('btn-edit')) {
                const trade = tradingData.find(t => t.id === id);
                recordBeingEditedId = id;
                Object.keys(trade).forEach(key => {
                    const el = document.getElementById(key);
                    if (el) el.value = trade[key];
                });
                ui.addOrUpdateTradeBtn.textContent = 'Update Trading';
                ui.cancelEditBtn.style.display = 'inline-block';
                ui.tradeForm.scrollIntoView({ behavior: 'smooth' });
            }
        });

        ui.cancelEditBtn.addEventListener('click', resetForm);
        ui.initialBalanceInput.addEventListener('change', fullUpdate);
        window.addEventListener('resize', drawEquityChart);

        function fullUpdate() {
            renderTable();
            updateAllStats();
            drawEquityChart();
        }

        // --- Initial Load Logic ---
        function initialize() {
            resetForm();
            tradingData = loadFromCache();
            if (tradingData.length > 0) {
                ui.syncStatus.textContent = 'Menampilkan data dari cache...';
                fullUpdate();
            }
            // Selalu coba sinkronisasi setelah memuat dari cache
            syncWithAirtable();
        }

        initialize();
    });
    </script>
</body>
</html>



